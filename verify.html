<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>校園請假憑證 驗證端</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: linear-gradient(135deg, #fffbe6 0%, #f2f9f9 100%); padding: 20px; }
    .verify-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 24px rgba(239,201,68,0.27);
      padding: 40px;
      max-width: 420px;
      margin: 30px auto;
      text-align: center;
    }
    .verify-header {
      color: #b57913;
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .qrcode-section img {
      max-width: 220px;
      margin-bottom: 10px;
    }
    .btn-primary {
      background: #b6903e;
      border: none;
    }
    #polling-status {
      font-size: 1rem;
      color: #666;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="verify-card shadow">
    <div class="verify-header">校園請假憑證 驗證端</div>
    <button id="btnGenerate" class="btn btn-primary w-100 mb-3">產生驗證QRCode</button>
    <div id="result"></div>
  </div>

<script>
  let pollingTimer = null;
  let currentTransactionId = null;

  document.getElementById('btnGenerate').addEventListener('click', () => {
    fetch('/api/generate-vp-qrcode')
      .then(res => res.json())
      .then(result => {
        if(result.error){
          showError('產生QRCode失敗：' + result.error);
          return;
        }
        currentTransactionId = result.transactionId;
        showQRCode(result.qrcode, result.authUri);
        startPolling();
      })
      .catch(() => {
        showError('伺服器未回應，請稍後再試。');
      });
  });

  function showQRCode(qrImg, authUri){
    const html = `
      <div class="alert alert-success">請將下方 QRCode 出示給學生使用數位皮夾 App 掃描！</div>
      <div class="qrcode-section">
        <img src="${qrImg}" alt="驗證 QRCode"/>
        <div><a href="${authUri}" target="_blank">直接點此啟用數位皮夾 App (DeepLink)</a></div>
      </div>
      <div id="polling-status">等待學生送出憑證...</div>
    `;
    document.getElementById('result').innerHTML = html;
  }

  function showError(msg){
    document.getElementById('result').innerHTML = `<div class="alert alert-danger">${msg}</div>`;
  }

  function startPolling(){
    if(pollingTimer) clearInterval(pollingTimer);
    if(!currentTransactionId) return;
    pollingTimer = setInterval(() => {
      fetch(`/api/poll-transaction?transactionId=${currentTransactionId}`)
        .then(res => res.json())
        .then(data => {
          if(data.error){
            document.getElementById('polling-status').innerText = '查詢錯誤：' + data.error;
            clearInterval(pollingTimer);
            return;
          }
          if(data.received){
            // 掃描成功：移除 QR 及按鈕區，僅保留成功訊息
            document.getElementById('result').innerHTML = `
              <div class="alert alert-success" style="font-size:1.15rem;">
                學生掃描並成功送出請假憑證，驗證通過！
              </div>
            `;
            clearInterval(pollingTimer);
          } else {
            document.getElementById('polling-status').innerText = '等待學生送出憑證...';
          }
        })
        .catch(() => {
          document.getElementById('polling-status').innerText = '查詢失敗，請稍後重試。';
          clearInterval(pollingTimer);
        });
    }, 3000);
  }

  // 按鈕顯示控制（只保留一次操作機會）
  document.getElementById('btnGenerate').addEventListener('click', () => {
    document.getElementById('btnGenerate').disabled = true; // 禁用按鈕，防止重覆產生
    fetch('/api/generate-vp-qrcode')
      .then(res => res.json())
      .then(result => {
        if(result.error){
          showError('產生QRCode失敗：' + result.error);
          document.getElementById('btnGenerate').disabled = false;
          return;
        }
        currentTransactionId = result.transactionId;
        showQRCode(result.qrcode, result.authUri);
        startPolling();
      })
      .catch(() => {
        showError('伺服器未回應，請稍後再試。');
        document.getElementById('btnGenerate').disabled = false;
      });
  });

</script>
</body>
</html>
