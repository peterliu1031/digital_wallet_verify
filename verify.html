<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>校園請假憑證 驗證端</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
  #result { margin-top: 20px; }
  img { max-width: 220px; }
</style>
</head>
<body>
<h1>校園請假憑證 驗證端</h1>
<button id="btnGenerate">產生驗證QRCode</button>
<div id="result"></div>

<script>
let pollingTimeout = null;
let currentTransactionId = null;

document.getElementById('btnGenerate').addEventListener('click', () => {
  fetch('/api/generate-vp-qrcode')
    .then(res => res.json())
    .then(result => {
      if (result.error) {
        document.getElementById('result').innerHTML = `<p style="color:red;">產生QRCode失敗：${result.error}</p>`;
        return;
      }
      currentTransactionId = result.transactionId;
      document.getElementById('result').innerHTML = `
        <p>請將下方QRCode出示給學生，請學生使用數位皮夾App掃描！</p>
        <img src="${result.qrcode}" alt="QRCode"/>
        <p><a href="${result.authUri}" target="_blank">直接點此啟用數位皮夾App (DeepLink)</a></p>
        <p id="pollingStatus">等待學生送出憑證...</p>
      `;
      startPolling();
    })
    .catch(() => {
      document.getElementById('result').innerHTML = '<p style="color:red;">伺服器未回應，請檢查後端。</p>';
    });
});

function startPolling() {
  if (pollingTimeout) clearTimeout(pollingTimeout);
  if (!currentTransactionId) return;

  fetch(`/api/poll-transaction?transactionId=${currentTransactionId}`)
    .then(res => res.json())
    .then(data => {
      if(data.error){
        document.getElementById('pollingStatus').innerText = '查詢錯誤：' + data.error;
        return;
      }
      if (data.received) {
        document.getElementById('pollingStatus').innerText = '學生已成功送出請假憑證，驗證通過！';
      } else {
        document.getElementById('pollingStatus').innerText = '等待學生送出憑證...';
        pollingTimeout = setTimeout(startPolling, 3000);
      }
    })
    .catch(() => {
      document.getElementById('pollingStatus').innerText = '查詢失敗，請稍後再試。';
    });
}
</script>
</body>
</html>
